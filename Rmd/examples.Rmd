---
title: "Worked examples"
output:
  md_document:
    variant: markdown_github

---

```{r setup, include = FALSE}
require(pavo)
require(scatterplot3d)
require(ggplot2)
require(gridExtra)
require(vegan)
require(MASS)
# require(lme4)

knitr::opts_chunk$set(echo = TRUE, 
                      fig.path='../output/figures/examples/examples_fig')
knitr::opts_knit$set(root.dir=normalizePath(".."))
```

# Worked examples

```{r}

source('R/bootstrapcentroiddS.R')
source('R/trispace.R')

# Distance matrix generator
distmat <- function(x){
  dmat <- matrix(0, nrow=length(unique(x$patch1)), ncol=length(unique(x$patch1)))
  rownames(dmat) <- colnames(dmat) <- as.character(unique(x$patch1))
  
  for(i in rownames(dmat))
    for(j in colnames(dmat))
      if(length(x$dS[x$patch1 == i & x$patch2 == j]) != 0)
      dmat[i,j] <- dmat[j,i] <- x$dS[x$patch1 == i & x$patch2 == j]
  
  dmat
  
}

```

## Example 1: Dichromatism. 

Reflectance data from four body regions of male and female _Ctenophorus ornatus_ (Whiting et al. 2015, Biol J Linn Soc). Labium, throat, tongue, and mouth-roof.

**Q:** Which body regions are sexually dichromatic?

Calculate deltaS according to conspecific (tetrachromatic) visual system

```{r message=FALSE, warning=FALSE}

specs <- list(all = as.rspec(read.csv('data/dichromatism/combined.csv'), interp = FALSE),
              lab = as.rspec(read.csv('data/dichromatism/lab.csv'), interp = FALSE),
              throat = as.rspec(read.csv('data/dichromatism/throat.csv'), interp = FALSE),
              roof = as.rspec(read.csv('data/dichromatism/roof.csv'), interp = FALSE),
              tongue = as.rspec(read.csv('data/dichromatism/tongue.csv'), interp = FALSE))

# Ctenophorus ornatus
liz_vis <- sensmodel(c(360, 440, 493, 571)) 
names(liz_vis) <- c('wl', 'u', 's', 'm', 'l')

models <- lapply(specs, function(x) vismodel(x, visual = liz_vis, relative = FALSE, 
                                             qcatch = "fi", scale = 10000))  # deltaS
models_rel <- lapply(specs, function(x) vismodel(x, visual = liz_vis, relative = TRUE, 
                                                 qcatch = "fi", scale = 10000))  # tcs 

deltaS <- lapply(models, function(x) coldist(x, achro = FALSE, n1 = 1, n2 = 1, 
                                             n3 = 3.5, n4 = 6, v = 0.10, noise = 'neural'))

```

Visualise
```{r liz_spectcs, fig.width=6, fig.height=9, message=FALSE, warning=FALSE}
layout(matrix(c(1, 2, 3, 4, 5, 6, 7, 8), 4, 2, byrow = TRUE))

aggplot(as.rspec(cbind(specs$lab$wl, specs$lab[grepl("M", colnames(specs$lab))])), ylim = c(0, 50), lcol = 'black', shadecol = 'black')
par(new = TRUE)
aggplot(as.rspec(cbind(specs$lab$wl, specs$lab[grepl("F", colnames(specs$lab))])), ylim = c(0, 50), lcol = 'red', shadecol = 'red')

sp3d <- scatterplot3d(suppressWarnings(tcs(models_rel$lab[grepl("M", rownames(models_rel$lab)), ])
                                       [, c('x','y','z')]), pch=19, box=F, main = 'labium', label.tick.marks = FALSE)
sp3d$points3d(suppressWarnings(tcs(models_rel$lab[grepl("F", rownames(models_rel$lab)), ])
                               [, c('x','y','z')]), col='red',pch=19)

aggplot(as.rspec(cbind(specs$throat$wl, specs$throat[grepl("M", colnames(specs$throat))])), ylim = c(0, 50), lcol = 'black', shadecol = 'black')
par(new = TRUE)
aggplot(as.rspec(cbind(specs$throat$wl, specs$throat[grepl("F", colnames(specs$throat))])), ylim = c(0, 50), lcol = 'red', shadecol = 'red')

sp3d <- scatterplot3d(suppressWarnings(tcs(models_rel$throat[grepl("M", rownames(models_rel$throat)), ])
                                       [, c('x','y','z')]), pch=19, box=F, main = 'throat', label.tick.marks = FALSE)
sp3d$points3d(suppressWarnings(tcs(models_rel$throat[grepl("F", rownames(models_rel$throat)), ])
                               [, c('x','y','z')]), col='red',pch=19)

aggplot(as.rspec(cbind(specs$roof$wl, specs$roof[grepl("M", colnames(specs$roof))])), ylim = c(0, 50), lcol = 'black', shadecol = 'black')
par(new = TRUE)
aggplot(as.rspec(cbind(specs$roof$wl, specs$roof[grepl("F", colnames(specs$roof))])), ylim = c(0, 50), lcol = 'red', shadecol = 'red')

sp3d <- scatterplot3d(suppressWarnings(tcs(models_rel$roof[grepl("M", rownames(models_rel$roof)), ])
                                       [, c('x','y','z')]), pch=19, box=F, main = 'roof', label.tick.marks = FALSE)
sp3d$points3d(suppressWarnings(tcs(models_rel$roof[grepl("F", rownames(models_rel$roof)), ])
                               [, c('x','y','z')]), col='red',pch=19)

aggplot(as.rspec(cbind(specs$tongue$wl, specs$tongue[grepl("M", colnames(specs$tongue))])), ylim = c(0, 50), lcol = 'black', shadecol = 'black')
par(new = TRUE)
aggplot(as.rspec(cbind(specs$tongue$wl, specs$tongue[grepl("F", colnames(specs$tongue))])), ylim = c(0, 50), lcol = 'red', shadecol = 'red')

sp3d <- scatterplot3d(suppressWarnings(tcs(models_rel$tongue[grepl("M", rownames(models_rel$tongue)), ])
                                       [, c('x','y','z')]), pch=19, box=F, main = 'tongue', label.tick.marks = FALSE)
sp3d$points3d(suppressWarnings(tcs(models_rel$tongue[grepl("F", rownames(models_rel$tongue)), ])
                               [, c('x','y','z')]), col='red',pch=19)
```

**Step 1:** PERMANOVAs

```{r}

# Setup distance matrices & groupings for each body part
mat <- list(all = distmat(deltaS$all),
            lab = distmat(deltaS$lab),
            throat = distmat(deltaS$throat),
            roof = distmat(deltaS$roof),
            tongue = distmat(deltaS$tongue))
group <- list(all = paste0(substring(rownames(mat$all), nchar(rownames(mat$all))), substring(rownames(mat$all), 1, 1)),
              lab = substring(rownames(mat$lab), 1, 1),
              throat = substring(rownames(mat$throat), 1, 1),
              roof = substring(rownames(mat$roof), 1, 1),
              tongue = substring(rownames(mat$tongue), 1, 1))

# Labium
adonis(mat$lab ~ group$lab)

# Mouth-roof
adonis(mat$roof ~ group$roof)

# Throat
adonis(mat$throat ~ group$throat)

# Tongue
adonis(mat$tongue ~ group$tongue)

```

**LESS SHITTY ALTERNATIVE?**

Combine all tests into one using sliding contrasts

```{r}

# Planned contrasts
cpatch <- factor(group$all)

levels(cpatch)  # First letter indicates body region, second indicates sex (see below for key)

contrasts(cpatch) <- contr.sdif(8)  # Sliding contrasts

# Design matrix without intercept
cgmmat <- model.matrix(~cpatch)[,-1]

# Run the model testing only contrasts of interest (m vs f body regions) i.e:
# HF vs HM (2-1), throat
# LM vs LF (4-3), labium
# RF vs RM (6-5), mouth-roof
# TF vs TM (8-7), tongue
adonis2(mat$all ~ cgmmat[,'cpatch2-1'] + cgmmat[,'cpatch4-3'] + 
          cgmmat[,'cpatch6-5'] + cgmmat[,'cpatch8-7'] , by = 'margin')

```

TW: Yeah that's not right - see individual tests above. Should be labium (4-3) = distinct, throat (2-1) = distinct, mouth (6-5) = nope, tongue (8-7) = nope. Should 'sex' be split off as a factor? ...

**Step 2:** Effect sizes.

Add grouping variable to raw models, then bootstrap centroids for statistically distinct patches, as identified in step 1 (labium & throat).

```{r}

# Groups
models$lab$group <- substring(rownames(models$lab), 1, 1)
models$throat$group <- substring(rownames(models$throat), 1, 1)

# labium
bootcentroidDS(models$lab[,1:4], models$lab$group, n1 = 1, n2 = 1, n3 = 3.5, n4 = 6, v = 0.10)

# throat
bootcentroidDS(models$throat[,1:4], models$throat$group, n1 = 1, n2 = 1, n3 = 3.5, n4 = 6, v = 0.10)

```

So lab's & throats are statistically distinct, but fall below threshold.

```{r}

rm(list = setdiff(ls(), lsf.str()))

```

## Example 2: Mimicry. 

Reflectance data from colour-polymorphic female spiders _Gasteracantha fornicata_, and sympatic flowers from Qld, Australia. (W = white morph, Y = yellow morph, F = flowers)

So three groups, with **two Q's:** 

**(1)** Are spiders actually polymorphic (to prey), as naively seems to be the case (for humans)?

**(2)** Do spiders (of each morph) resemble sympatric flowers?

Calculate deltaS (JNDs) according to a honeybee

```{r}

specs <- as.rspec(read.csv('data/mimicry/flowers_spiders.csv'), interp = FALSE)

# Honeybee
bee_vis <- sensmodel(c(344, 436, 556), beta = FALSE) 
names(bee_vis) <- c('wl','s', 'm', 'l')

# Receptor-noise
models <- vismodel(specs, visual = bee_vis, relative = FALSE,
                                                 qcatch = "fi", scale = 10000)  # rn
models_rel <- vismodel(specs, visual = bee_vis, relative = TRUE,
                                                 qcatch = "fi", scale = 10000)  # for plotting
models_tri <- trispace(models_rel)

deltaS <- coldist(models, achro = FALSE, n1 = 1, n2 = 0.471, n3 = 4.412, v = 0.13)

models$group <- substring(rownames(models), 1, 1)
bootcentroidDS(models[, 1:3], models$group, vis = 'tri', n1 = 1, n2 = 0.471, n3 = 4.412, v = 0.13)

# Contrast labels
deltaS$comparison[grepl('W_', deltaS$patch1) & grepl('W_', deltaS$patch2)] <- 'intra.W'
deltaS$comparison[grepl('Y_', deltaS$patch1) & grepl('Y_', deltaS$patch2)] <- 'intra.Y'
deltaS$comparison[grepl('F_', deltaS$patch1) & grepl('F_', deltaS$patch2)] <- 'intra.F'
deltaS$comparison[grepl('Y_', deltaS$patch1) & grepl('W_', deltaS$patch2)] <- 'inter.WY'
deltaS$comparison[grepl('W_', deltaS$patch1) & grepl('F_', deltaS$patch2)] <- 'inter.WF'
deltaS$comparison[grepl('Y_', deltaS$patch1) & grepl('F_', deltaS$patch2)] <- 'inter.YF'

```

Visualise.

```{r mimic_triplot, fig.width=6, fig.height=6}

# Max triangle
triplot(models_tri[grepl("F_", rownames(models_tri)), ], col = 'black', bg = 'forestgreen', cex = 1.3, pch = 21, achro = FALSE)
points(models_tri[grepl("Y_", rownames(models_tri)), ][c('x', 'y')], pch = 21, col = 'black', bg = 'darkgoldenrod1', cex = 1.3)
points(models_tri[grepl("W_", rownames(models_tri)), ][c('x', 'y')], pch = 21, col = 'black', bg = 'darkgrey', cex = 1.3)
```

**PERMANOVA**
```{r}

# Set up distance matrices & groupings for focal comparisons 
mat <- list(all = distmat(deltaS),
            WY = distmat(subset(deltaS, !(comparison %in% c('intra.F', 'inter.WF', 'inter.YF')))),
            WF = distmat(subset(deltaS, !(comparison %in% c('intra.Y', 'inter.WY', 'inter.YF')))),
            YF = distmat(subset(deltaS, !(comparison %in% c('intra.W', 'inter.WY', 'inter.WF'))))
            )
group <- list(all = substring(rownames(mat$all), 1, 1),
              WY = substring(rownames(mat$WY), 1, 1),
              WF = substring(rownames(mat$WF), 1, 1),
              YF = substring(rownames(mat$YF), 1, 1))

# Use customized contrasts to test a priori hypotheses together
cgroups <- factor(group$all)

# Create the contrasts we want
contrasts(cgroups) <- cbind(
  c(-1, 0.5, 0.5), # compare F vs. W&Y, will be named "cgroups1"
  c(0, -0.5, 0.5)  # compare W vs Y, will be named "cgroups2"
  )

# Create design matrix, without intercept
cgmmat <- model.matrix(~cgroups)[,-1]

# Run the model testing only specified contrasts
adonis2(mat$all ~ cgmmat[, 'cgroups1'] + cgmmat[, 'cgroups2'], by='margin')
```

Note that the degrees of freedom, sums of squares, and R2 are the same between the two "full" models, but the specified contrasts let us test both hypotheses together. They would also be the same if you did adonis(mat$all ~ cgroups) (but you'd only get one P value and R2 representing the combined effects of both sets of contrasts)

**Effect sizes**
```{r}

models$group <- substring(rownames(models), 1, 1)
bootcentroidDS(models[, 1:3], models$group, vis = 'tri', n1 = 1, n2 = 0.471, n3 = 4.412, v = 0.13)

```

So the RN threshold for honeybees can be pretty damn low (0.3 JNDs, Dyer & Neumeyer 2005), but is variable depending on testing conditions, past experience etc. These would suggest that everying's (on average) perceptably distinct, but probably tough (depending on experience etc.).  

```{r}

rm(list = setdiff(ls(), lsf.str()))

```

## Example 3: Crypsis. 

Reflectance data from various body regions (H = head, L = left arm, R = right arm, P = prothorax, W = wing) of 27 female and 7 male mantids _Pseudomantis albofimbriata_ and 50 background samples (_Lomandra longifolia_, which they pretty much exclusively hang on).

So six groups, a couple of **Q's:** Are mantids cryptic? i.e. are all body regions chromaticically 
indistinguishable from their background? And are they any sex differences ('hidden' UV sexual signals perhaps)?

Calculate deltaS according to blue tits 

```{r}

specs <- as.rspec(read.csv('data/crypsis/mantids_bkgs.csv'), lim = c(300, 700))

```

```{r}

models <- vismodel(specs, visual = 'bluetit', relative = FALSE, qcatch = "fi", scale = 10000)  # deltaS
models_rel <- list(female = vismodel(as.rspec(cbind(specs$wl, specs[grepl("_F", colnames(specs))])), 
                                     visual = 'bluetit', relative = TRUE, qcatch = "fi", scale = 10000),
                   male = vismodel(as.rspec(cbind(specs$wl, specs[grepl("_M", colnames(specs))])), 
                                     visual = 'bluetit', relative = TRUE, qcatch = "fi", scale = 10000),
                   bkg = vismodel(as.rspec(cbind(specs$wl, specs[grepl("B_", colnames(specs))])), 
                                     visual = 'bluetit', relative = TRUE, qcatch = "fi", scale = 10000))

deltaS <- coldist(models, achro = FALSE)

```

Visualise

```{r crypsis_tcs, fig.width=7, fig.height=7}

cols <- c('darkgoldenrod', 'darkgoldenrod1', 'darkgoldenrod2', 'darkgoldenrod3', 'darkgoldenrod4')

layout(matrix(c(1, 2, 3, 4), 2, 2, byrow = TRUE))

# Female specs
aggplot(as.rspec(cbind(specs$wl, specs[grepl("_F", colnames(specs))])), 
        by =  substring(names(specs[grepl("_F", colnames(specs))]), 1, 1), 
        ylim = c(0, 100),
        lcol = 'black',
        shadecol = cols)

# Female tcs
sp3d <- scatterplot3d(suppressWarnings(tcs(models_rel$bkg)[, c('x','y','z')]), 
                                       xlim=c(-0.02,0.03), ylim=c(-0.01,0.028), zlim=c(-0.06,0.01), 
                                       pch=19, box=F, color = 'forestgreen', label.tick.marks = FALSE)
sp3d$points3d(suppressWarnings(tcs(models_rel$female[grepl("H_", rownames(models_rel$female)), ])
                               [, c('x','y','z')]), col='darkgoldenrod',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$female[grepl("L_", rownames(models_rel$female)), ])
                               [, c('x','y','z')]), col='darkgoldenrod1',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$female[grepl("R_", rownames(models_rel$female)), ])
                               [, c('x','y','z')]), col='darkgoldenrod2',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$female[grepl("P_", rownames(models_rel$female)), ])
                               [, c('x','y','z')]), col='darkgoldenrod3',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$female[grepl("W_", rownames(models_rel$female)), ])
                               [, c('x','y','z')]), col='darkgoldenrod4',pch=19)

# Male specs
aggplot(as.rspec(cbind(specs$wl, specs[grepl("_M", colnames(specs))])), 
        by =  substring(names(specs[grepl("_M", colnames(specs))]), 1, 1), 
        ylim = c(0, 100),
        lcol = 'black',
        shadecol = cols)

# Male tcs
sp3d <- scatterplot3d(suppressWarnings(tcs(models_rel$bkg)[, c('x','y','z')]), 
                                       xlim=c(-0.02,0.03), ylim=c(-0.01,0.028), zlim=c(-0.06,0.01), 
                                       pch=19, box=F, color = 'forestgreen', label.tick.marks = FALSE)
sp3d$points3d(suppressWarnings(tcs(models_rel$male[grepl("H_", rownames(models_rel$male)), ])
                               [, c('x','y','z')]), col='darkgoldenrod',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$male[grepl("L_", rownames(models_rel$male)), ])
                               [, c('x','y','z')]), col='darkgoldenrod1',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$male[grepl("R_", rownames(models_rel$male)), ])
                               [, c('x','y','z')]), col='darkgoldenrod2',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$male[grepl("P_", rownames(models_rel$male)), ])
                               [, c('x','y','z')]), col='darkgoldenrod3',pch=19)
sp3d$points3d(suppressWarnings(tcs(models_rel$male[grepl("W_", rownames(models_rel$male)), ])
                               [, c('x','y','z')]), col='darkgoldenrod4',pch=19)
```

**Step 1:** PERMANOVA

```{r}

# Set up distance matrices & groupings for focal comparisons 
mat <- distmat(deltaS)
patch <- substring(rownames(mat), 1, 1)  # body part
sex <- substring(rownames(mat), nchar(rownames(mat)))  # sex (Male, Female, None (bkg))  

# Specify contrasts based on the questions:
# contrasts for patch
cpatch <- factor(patch)
contrasts(cpatch) <- cbind(c(-1, 0.2, 0.2, 0.2, 0.2, 0.2), # B vs HLPRW
                           rep(0, 6), rep(0,6), rep(0,6), rep(0,6))

# we don't really care about HxLxPxRxW right? so that should do it
csex <- factor(sex)
contrasts(csex) <- cbind(
                        c(-1,1,0), # M vs F
                        rep(0,3) # we don't care about comparisons with N
                        )

# without interaction
adonis2(mat ~ cpatch + csex, by = 'margin')

```

**note reduced degrees of freedom**

also note that in this scenario, the "interaction" becomes nonsingular and unidentifiable - since all patches are treated as one group and the background as another, and the background is ignored in the sex variable, then the interaction and the sex align perfectly:

(HLPRW):F == F
(HLPRW):M == M
(HLPRW):B == 0

 We can show that there are no degrees of freedom for this comparison:
 
```{r}
# get model matrix 
modmat <- model.matrix(~cpatch * csex)

# only columns that interest us:
# cpatch1: B vs HLPRW
# csex1: M vs F, ignore N
# cpatch1:csex1: their interaction

modmat <- modmat[, c("cpatch1", "csex1", "cpatch1:csex1")]

adonis2(mat ~ modmat, by='margin')
```

We can change the contrasts to show an interaction in the form of a sex-by-patch effect, but since we are ignoring the patch differences when testing for crypsis, maybe we shouldn't? 

ALSO, note that the contrasts I designed are testing the hypothesis: "are males different from females?" We could also change the contrasts to test MxB x FxB (that is, do the sexes contrast with the background differently) - but given the threshold results that might not even be worth it!

**Step 2:** Effect sizes
```{r}

# Splitting up by sex. Need to tidy this up.
models$patch <- substring(rownames(models), 1, 1)
models$sex <- substring(rownames(models), nchar(rownames(models)))

models_m <- subset(models, sex != 'F')
models_f <- subset(models, sex != 'M')

cents_m <- bootcentroidDS(models_m[,1:4], models_m$patch)
cents_f <- bootcentroidDS(models_f[,1:4], models_f$patch)

cents_m <- as.data.frame(cents_m[grep("B", rownames(cents_m)), ])  # Mantid-background contrasts only
cents_f <- as.data.frame(cents_f[grep("B", rownames(cents_f)), ])

cents_m$sex <- 'M'
cents_f$sex <- 'F'
cents_m$comp <- rownames(cents_m)
cents_f$comp <- rownames(cents_f)

cents <- rbind(cents_m, cents_f)

```

Plot (patch * sex)-versus-bkg bootstrapped centroid distances

```{r crypsis_effectplot, fig.width=8, fig.height=6}

  pd <- position_dodge(.5)
  ggplot(cents, aes(x = sex, y = measured.dS, colour = comp, group = comp)) + 
    geom_errorbar(aes(ymin = CI.lwr, ymax = CI.upr), colour = "black", width = .2, position = pd) +
    geom_point(aes(fill = comp), position = pd, size = 3, shape = 21, colour = 'black') + 
    geom_hline(yintercept = 1, linetype = 2) +
    scale_y_continuous(limits = c(0, 1.2)) +
    ylab("dS") +
    theme(legend.position = 'none')  

```

So all patches are below threshold (i.e. cryptic), and there are some very minor, imperceptible differences between sexes.

```{r}
sessionInfo()
```
